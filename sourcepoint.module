<?php
/**
 * @file
 * Code for the Sourcepoint core module.
 */

spl_autoload_register('sourcepoint_autoload', TRUE, TRUE);

/**
 * PSR-4 autoloader callback for spl_autoload_register().
 *
 * @param $class
 */
function sourcepoint_autoload($class) {
  if (file_exists(__DIR__ . '/' . $class . '.class.php')) {
    include(__DIR__ . '/' . $class . '.class.php');
  }
}

/**
 * Implements hook_menu().
 */
function sourcepoint_menu() {
  $items['admin/config/system/sourcepoint'] = array(
    'title' => 'Sourcepoint',
    'description' => 'Configure Sourcepoint parameters.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('sourcepoint_admin_settings_form'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'sourcepoint.admin.inc',
  );
  // Page callback for src.
  if ($recovery_script_path = variable_get('sourcepoint_recovery_script_path')) {
    $items[$recovery_script_path] = array(
      'page callback' => 'sourcepoint_recovery_script_path',
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
    );
  }
  // Page callback for pub_base.
  if ($pub_base = variable_get('sourcepoint_pub_base')) {
    $pub_base = parse_url($pub_base);
    $pub_base = $pub_base['path'];
    $pub_base = trim($pub_base, '/');
    $items[$pub_base] = array(
      'page callback' => 'sourcepoint_pub_base_page',
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
    );
  }

  return $items;
}

/**
 * Page callback for recovery script path.
 */
function sourcepoint_recovery_script_path() {
  drupal_add_http_header('Content-Type', 'text/javascript');
  print sourcepoint_get_script('recovery');
  drupal_exit();
}

/**
 * Page callback for recovery script path.
 */
function sourcepoint_pub_base_page() {
  watchdog('sourcepoint', t('Pub base url hit %url. Did anything go wrong with the apache redirect?', array('%url' => current_path())), [], WATCHDOG_ERROR);
  header("HTTP/1.0 404 Not Found");
  drupal_exit();
}

/**
 * Implements hook_page_build().
 */
function sourcepoint_page_build() {

  if (path_is_admin(current_path())) {
    return;
  }

  if (!variable_get('sourcepoint_enabled', 1)) {
    return;
  }

  if ($script = sourcepoint_get_script('bootstrap')) {

    $script .= "\nwindow._sp_ = window._sp_ || {};";
    $script .= "\nwindow._sp_.config = window._sp_.config || {};";

    if ($account_id = variable_get('sourcepoint_account_id', '')) {
      $script .= "\nwindow._sp_.config.account_id = $account_id;";
    }

    if ($pub_base = variable_get('sourcepoint_pub_base', '')) {
      $script .= "\nwindow._sp_.config.publisher_base = '$pub_base';";
    }

    if ($landing_page = variable_get('sourcepoint_content_control_url', '')) {
      $script .= "\nwindow._sp_.config.content_control_callback = function() {";
      $script .= "\n\twindow.location.href = '$landing_page';\n};";
    }

    if ($recovery_script_path = variable_get('sourcepoint_recovery_script_path')) {
      $path = url($recovery_script_path, ['absolute' => TRUE]);
      $script .= "\nwindow.spBootstrap('$path');";
    }

    $element = array(
      '#tag' => 'script',
      '#weight' => 1,
      '#value' => $script,
      '#attributes' => array(
        'type' => 'text/javascript',
      ),
    );
    drupal_add_html_head($element, 'sourcepoint');
  }
}

/**
 * Function responsible to fetch the script from the server.
 *
 * @param      $script_type 'bootstrap or recovery'.
 * @param null $api_key The api key provided by sourcepoint.
 * @param null $options The options to go along with the request.
 *
 * @return null
 * @throws Exception
 */
function sourcepoint_fetch_script($script_type, $api_key = NULL, $options = NULL) {
  if (is_null($options)) {
    // Get options for the script.
    $options = _sourcepoint_get_script_options($script_type);
  }
  if (is_null($api_key)) {
    // Get API keys from settings.
    $api_key = variable_get('sourcepoint_api_key');
  }

  try {
    $endpoint = _sourcepoint_get_endpoint($script_type);
    $sourcePoint = new SourcePointAsset($endpoint, $api_key);
    $sourcePoint->setOptions($options);
    $response = $sourcePoint->fetch();

    if ($script = $response->script) {
      return $script;
    }
  } catch (Exception $e) {
    throw $e;
  }
}

function _sourcepoint_get_endpoint($script_type) {
  switch ($script_type) {
    case 'recovery':
      return 'cs_recovery';
      break;

    case 'bootstrap':
      return 'bootstrap';
      break;

    default:
      drupal_set_message(t('Script type "!type" is invalid.', array('!type' => $script_type)), 'error');
  }
}

/**
 * Helper to set the message on the script status.
 *
 * @param $message
 * @param $class
 *
 * @return string
 */
function _sourcepoint_set_message($message, $class) {
  return '<div class="' . $class . '">' . $message . '</div>';
}

/**
 * Helper to build the key used to store the script in the variables.
 *
 * @param $options
 *
 * @return string
 */
function _sourcepoint_build_script_key($options) {
  return implode('_', array_values($options));
}

/**
 * Helper to get the script from local storage.
 *
 * @param null  $script_type
 * @param array $form_state If this argument is passed, the values will be
 * retrieved from it. Default is to retrieve from settings.
 *
 * @return bool or the script
 */
function sourcepoint_get_script($script_type, $form_state = []) {
  $script_value = variable_get('sourcepoint_' . $script_type . '_script');
  $options = _sourcepoint_get_script_options($script_type, $form_state);
  $key = _sourcepoint_build_script_key($options);
  if (isset($script_value[$key])) {
    return $script_value[$key];
  }

  return FALSE;
}

/**
 * Helper to return the array of options and values for the Recovery script.
 *
 * @param array $form_state If this argument is passed, the values will be
 * retrieved from it. Default is to retrieve from settings.
 * @param null  $script_type
 *
 * @return array
 */
function _sourcepoint_get_script_options($script_type, $form_state = []) {
  switch ($script_type) {
    case 'recovery':
      if (isset($form_state['input']['sourcepoint_pub_base'])) {
        $pub_base = $form_state['input']['sourcepoint_pub_base'];
      }
      else {
        global $base_url;
        $pub_base = trim(variable_get('sourcepoint_pub_base', $base_url . '/pub/base'), '/');
      }

      if (isset($form_state['input']['sourcepoint_pub_adserver'])) {
        $pub_adserver = $form_state['input']['sourcepoint_pub_adserver'];
      }
      else {
        $pub_adserver = variable_get('sourcepoint_pub_adserver', 'dfp');
      }

      if (isset($form_state['input']['sourcepoint_env'])) {
        $env = $form_state['input']['sourcepoint_env'];
      }
      else {
        $env = variable_get('sourcepoint_env', 'prod');
      }

      if (isset($form_state['input']['sourcepoint_recovery_script_format'])) {
        $fmt = $form_state['input']['sourcepoint_recovery_script_format'];
      }
      else {
        $fmt = variable_get('sourcepoint_recovery_script_format', 'js');
      }

      return [
        'pub_base' => $pub_base,
        'pub_adserver' => $pub_adserver,
        'env' => $env,
        'fmt' => $fmt,
      ];
      break;

    case 'bootstrap':
      if (isset($form_state['input']['sourcepoint_bootstrap_script_version'])) {
        $version = $form_state['input']['sourcepoint_bootstrap_script_version'];
      }
      else {
        $version = variable_get('sourcepoint_bootstrap_script_version', '');
      }

      return [
        'v' => $version,
        'fmt' => 'js',
      ];
      break;

    default:
      drupal_set_message(t('Script type "!type" is invalid.', array('!type' => $script_type)), 'error');
  }

}
